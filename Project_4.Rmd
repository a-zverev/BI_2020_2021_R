---
title: "Project_4: Survive"
author: "Aleksei Zverev"
date: "8/3/2021"
output: 
  html_document: 
    keep_md: yes
    number_section: yes
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
library(survival)
library(survminer)
library(ranger)
library(ggplot2)
library(dplyr)
library(ggfortify)
library(coin)
```

# Intro

We analyse dataset from *survival* library, called *ovarian*. We hawe followed categories:

* futime:	survival or censoring time
* fustat:	censoring status
* age: 	age in years
* resid.ds:	residual disease present (1 = no, 2 = yes)
* rx:	treatment group
* ecog.ps:  ECOG performance status (1 = better, 2 = worse)

```{r}
data(ovarian)
head(ovarian)
```

# EDA

At all we have `r nrow(ovarian)`, without NA `r nrow(ovarian %>% na.omit)` - so, we can use all data.
Our data is censored - wisout censoring we have `r sum(ovarian$fustat == 0)` entries
How many groups we have in every category?

```{r}
ovarian  %>% group_by(fustat, resid.ds, rx, ecog.ps) %>% summarise(n_entries = n(), .groups = 'keep')
```

In range from 1 to 4. Not a lot of data, actually, but without zeros.

Is it any differences by age in different groups?

```{r}
data <- ovarian %>% mutate(group = factor(paste(ovarian$resid.ds, "+", ovarian$rx),
                           labels = c('New + First', 'New + Second', 'Residual + First', 'Residual + Second')))
ggplot(data, aes(x = age, y = group)) +
  geom_boxplot() + 
  geom_point(aes(color = as.factor(ecog.ps))) +
  scale_color_discrete(name = "ECOG Status")
```

Perhaps, no

# Caplan-Meyer

At first, calculate total curve and get some data about it

```{r}
km <- with(ovarian, Surv(futime, fustat))
km_fit <- survfit(Surv(futime, fustat) ~ 1, data=ovarian)

summary(km_fit, times = seq(1, 1200, length.out=12))
autoplot(km_fit)
```

How it can variate by different variables? 

```{r}
km_fit.desease <- survfit(Surv(futime, fustat) ~ resid.ds, data=ovarian)
autoplot(km_fit.desease)

km_fit.treatment <- survfit(Surv(futime, fustat) ~ rx, data=ovarian)
autoplot(km_fit.treatment)

km_fit.age <- survfit(Surv(futime, fustat) ~ age_f, data=ovarian %>% mutate(age_f = ifelse((age < 55), "less_55", "over_55")))
autoplot(km_fit.age)
```

Age looks like strong factor, followed by residual desease. Treatment group isn't look as strong factor

But, perhaps, our treatment will be better for different age, or without residual desease?

```{r}
ovarian_plus <- ovarian %>% mutate(age_cat = ifelse((age < 55), "less_55", "over_55"),
              age_cat = factor(age_cat),
              treatment = factor(rx, labels=c("First","Second")),
              prior = factor(resid.ds, labels=c("No", "Yes")),
              groups1 = factor(paste(age_cat, '+', treatment)),
              groups2 = factor(paste(age_cat, '+', prior)))

km_treatment_fit <- survfit(Surv(futime, fustat) ~ groups1, data=ovarian_plus)
autoplot(km_treatment_fit)

km_prior_fit <- survfit(Surv(futime, fustat) ~ groups2, data=ovarian_plus)
autoplot(km_prior_fit)
```

* Less, than 55 years and without previous disease - as expected, it is better case
* Less, than 55 years and second treatment is good idea. But how many obserwation we have? `r sum(ovarian_plus$groups1 == "less_55 + Second")` - not a lot of (over 55 with second treatment is `r sum(ovarian_plus$groups1 == "over_55 + Second") ` entries) 

# Groups by survival

Perform logrank test

```{r}
survdiff(Surv(futime, fustat) ~ treatment, data = ovarian_plus)
survdiff(Surv(futime, fustat) ~ age_cat, data = ovarian_plus)
survdiff(Surv(futime, fustat) ~ prior, data = ovarian_plus)
```

Ok, age as category is one and only significant group. How about age + treatment combination?

```{r}
logrank_test(Surv(futime, fustat) ~ groups1, data = ovarian_plus)
```

Nope(


# Estimate risc factors

```{r}
cox <- coxph(Surv(futime, fustat) ~ age + prior + treatment, data = ovarian_plus)
summary(cox)
```


Without interaction, just age is significant


```{r}
cox <- coxph(Surv(futime, fustat) ~ age * prior * treatment - age:prior:treatment, data = ovarian_plus)
summary(cox)
```


With interaction, none of them


```{r}
fit.coxph <- coxph(Surv(futime, fustat) ~ age + prior + treatment, data = ovarian_plus)
ggforest(fit.coxph, data = ovarian_plus)
```


But about riscs:

* Age is significant predictor: the younger you are, the better the result)
* With residual desease, you'll be not so good (but this is not sure)
* With secont type of treatment you'll be better (slso not sure)


